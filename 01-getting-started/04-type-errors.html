<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Type Errors - Writing Session-Typed Ferrite Programs in Rust</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../ferrite.html"><strong aria-hidden="true">1.</strong> Writing Session-Typed Ferrite Programs in Rust</a></li><li class="chapter-item expanded "><a href="../01-getting-started/00-getting-started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01-getting-started/01-installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../01-getting-started/02-hello-world.html"><strong aria-hidden="true">2.2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../01-getting-started/03-communication.html"><strong aria-hidden="true">2.3.</strong> Client Communication</a></li><li class="chapter-item expanded "><a href="../01-getting-started/04-type-errors.html" class="active"><strong aria-hidden="true">2.4.</strong> Type Errors</a></li><li class="chapter-item expanded "><a href="../01-getting-started/05-session-types.html"><strong aria-hidden="true">2.5.</strong> Session Types</a></li></ol></li><li class="chapter-item expanded "><a href="../02-main-concepts/00-main-concepts.html"><strong aria-hidden="true">3.</strong> Main Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02-main-concepts/01-protocols.html"><strong aria-hidden="true">3.1.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/02-linear-context.html"><strong aria-hidden="true">3.2.</strong> Linear Context</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/03-sessions.html"><strong aria-hidden="true">3.3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/04-channel-selectors.html"><strong aria-hidden="true">3.4.</strong> Channel Selectors</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/05-running-sessions.html"><strong aria-hidden="true">3.5.</strong> Running Sessions</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/06-hole-driven-development.html"><strong aria-hidden="true">3.6.</strong> Hole Driven Development</a></li></ol></li><li class="chapter-item expanded "><a href="../03-basic-constructs/00-basic-constructs.html"><strong aria-hidden="true">4.</strong> Basic Constructs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../03-basic-constructs/01-termination.html"><strong aria-hidden="true">4.1.</strong> Termination</a></li><li class="chapter-item expanded "><a href="../03-basic-constructs/02-send-receive-values.html"><strong aria-hidden="true">4.2.</strong> Send / Receive Values</a></li><li class="chapter-item expanded "><a href="../03-basic-constructs/03-send-receive-channels.html"><strong aria-hidden="true">4.3.</strong> Send / Receive Channels</a></li><li class="chapter-item expanded "><a href="../03-basic-constructs/04-external-choice.html"><strong aria-hidden="true">4.4.</strong> External Choice</a></li><li class="chapter-item expanded "><a href="../03-basic-constructs/05-internal-choice.html"><strong aria-hidden="true">4.5.</strong> Internal Choice</a></li></ol></li><li class="chapter-item expanded "><a href="../04-advanced-constructs/00-advanced-constructs.html"><strong aria-hidden="true">5.</strong> Advanced Constructs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../04-advanced-constructs/01-recursive-session-types.html"><strong aria-hidden="true">5.1.</strong> Recursive Session Types</a></li><li class="chapter-item expanded "><a href="../04-advanced-constructs/02-communication.html"><strong aria-hidden="true">5.2.</strong> Communication</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Shared Session Types</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Example Usage</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">7.1.</strong> Communication Protocols</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> Shared Resources</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Ferrite Internals</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.1.</strong> Higher Kinded Types</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.2.</strong> Cloaking Constraints</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.</strong> Optics</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.</strong> Row Polymorphism</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Conclusion</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> TODO</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Writing Session-Typed Ferrite Programs in Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#type-errors" id="type-errors">Type Errors</a></h1>
<p>The way we write a Ferrite program is quite different from how we typically
write a Rust program. This is because Ferrite makes use of Rust's type system
to provide additional safeguard on how session type channels can be used.</p>
<p>We can take a quick look of some error messages raised when our Ferrite
programs are written incorrectly.</p>
<h2><a class="header" href="#an-incorrect-hello-provider" id="an-incorrect-hello-provider">An Incorrect Hello Provider</a></h2>
<p>Let's consider the <code>hello_provider</code> program that we have written in the
previous chapter:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>  let hello_provider: Session&lt;Hello&gt; =
    send_value(&quot;Hello World!&quot;.to_string(), terminate());
<span class="boring">}
</span></code></pre></pre>
<p>According to the <code>Hello</code> protocol, <code>SendValue&lt;String, End&gt;</code>,
<code>hello_provider</code> is supposed to send a string value before terminating.
But what if we implement <code>hello_provider</code> such that it terminates
immediately without sending a string?</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let hello_provider_incorrect: Session&lt;Hello&gt; = terminate();
<span class="boring">}
</span></code></pre></pre>
<p>In this case, if we try to compile our program, we would get a compile
error from Rust showing a message similar to as follows:</p>
<pre><code>error[E0308]: mismatched types
 |   let hello_provider_incorrect: Session&lt;Hello&gt; = terminate();
 |                                 --------------   ^^^^^^^^^^^ expected struct `ferrite_session::prelude::SendValue`, found struct `ferrite_session::prelude::End`
 |                                 |
 |                                 expected due to this
 |
 = note: expected struct `PartialSession&lt;(), ferrite_session::prelude::SendValue&lt;String, ferrite_session::prelude::End&gt;&gt;`
            found struct `PartialSession&lt;_, ferrite_session::prelude::End&gt;`
</code></pre>
<p>The error message above has been slightly prettified to make it more readable,
but the content remains the same. First of all, we see that the error is about
type mismatch between a <code>PartialSession</code> type, which we will cover in a
<a href="../03-main-concepts/03-partial-sessions.html">later chapter</a>.</p>
<p>Inside the second type parameter of <code>PartialSession</code>, notice that
there is a mismatch between the expected session type
<code>SendValue &lt; String, End &gt;</code>, and the actual session type <code>End</code>. From that,
we can deduce that <code>hello_provider_incorrect</code> has violated the <code>Hello</code>
protocol, by instead offering the protocol <code>End</code>.</p>
<h2><a class="header" href="#an-incorrect-hello-client" id="an-incorrect-hello-client">An Incorrect Hello Client</a></h2>
<p>The error message we get from <code>hello_provider_incorrect</code> is relatively simple,
as the type mismatch is on the offered channel. On the other hand, recall that
<code>hello_client</code> deals with <em>two</em> channels: one with the receiver end of <code>Hello</code>,
and one that offers the session type <code>End</code>.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>  let hello_client: Session&lt;ReceiveChannel&lt;Hello, End&gt;&gt; =
    receive_channel(|a| {
      receive_value_from(a, move |greeting| {
        println!(&quot;Received greetings from provider: {}&quot;, greeting);
        wait(a, terminate())
      })
    });
<span class="boring">}
</span></code></pre></pre>
<p>Based on the protocol specification, it looks like <code>hello_client</code> should be able
to receive a <code>Hello</code> channel, ignores the channel, and proceed to terminate
immediately. So let's try implementing a new client to do just that:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let hello_client_incorrect: Session&lt;ReceiveChannel&lt;Hello, End&gt;&gt; =
  receive_channel(|provider| {
    terminate()
  });
<span class="boring">}
</span></code></pre></pre>
<p>In <code>hello_client_incorrect</code>, the <code>provider</code> channel is ignored after we have received
it, and we proceed to call <code>terminate</code> immediately. If we try to build this,
we would instead get the following compile error:</p>
<pre><code>error[E0277]: the trait bound `(ferrite_session::prelude::SendValue&lt;String, ferrite_session::prelude::End&gt;, ()): ferrite_session::internal::base::EmptyContext` is not satisfied
 |
 |     terminate()
 |     ^^^^^^^^^ the trait `ferrite_session::internal::base::EmptyContext` is not implemented for `(ferrite_session::prelude::SendValue&lt;String, ferrite_session::prelude::End&gt;, ())`
 |
 |
 |   C: EmptyContext,
 |      ------------ required by this bound in `ferrite_session::prelude::terminate`
 |
 = help: the following implementations were found:
           &lt;(ferrite_session::prelude::Empty, R) as ferrite_session::internal::base::EmptyContext&gt;
</code></pre>
<p>The error can look a bit scary, but it mainly boils down to two constructs:
a new type <code>(SendValue&lt;String, End&gt;, ())</code> and a new trait <code>EmptyContext</code>.</p>
<p>The type <code>(SendValue&lt;String, End&gt;, ())</code> represents the <em>linear context</em> in
<code>hello_client_incorrect</code>, when the expression <code>terminate()</code> is called. We will
cover the details of linear context in a
<a href="../03-main-concepts/02-linear-context.html">later chapter</a>. For now it is sufficient
to know that it is used to track the <code>provider</code> channel we have just received,
and it has the session type <code>SendValue&lt;String, End&gt;</code>.</p>
<p>The <code>EmptyContext</code> trait is essentially telling us that in order to use the
<code>terminate()</code> construct, the current linear context must be empty.
However because we have not yet used up the <code>provider</code> channel, the
linear context is thus not empty, and so we cannot terminate just yet.</p>
<h2><a class="header" href="#enforcing-linear-usage-at-compile-time" id="enforcing-linear-usage-at-compile-time">Enforcing Linear Usage at Compile Time</a></h2>
<p>The error from <code>hello_client_incorrect</code> shows us how Ferrite enforces linear
usage of session type channels at compile time. This can greatly reduce the
chance of us writing incorrect Ferrite programs that just abort in the
middle of communicating with other processes.</p>
<p>The linear usage of Ferrite channels is different from the <em>affine</em> usage
of Rust objects. Consider an equivalent of <code>hello_client</code> implemented
using <a href="https://doc.rust-lang.org/std/sync/mpsc/fn.channel.html">Rust channels</a>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn hello_client_rust(receiver: Receiver&lt;String&gt;) {
  // drops receiver immediately
}
<span class="boring">}
</span></code></pre></pre>
<p>In standard Rust programs, we establish communication between concurrent
processes by explicitly passing the sender or receiver end of a Rust channel
as function argument. However since the Rust channel is just an affine
Rust object, it is possible that one party drops the channel half way,
intentionally or not.</p>
<p>In the simple case of our <code>Hello</code> protocol, the dropping of a channel
might not seem critical. But what if the protocol is slightly more complicated?</p>
<p>Let's say we have an <code>Ping</code> protocol with the session type
<code>ReceiveValue&lt;String, SendValue&lt;String, End&gt;&gt;</code>. This would require the
provider to receive a string value before sending back another string value,
and vice versa for the client. If a client drops the channel without
sending a value to the provider, the provider would potentially wait forever
without receiving the string.</p>
<p>Even if the provider can somehow detect that the client has dropped the
channel half way, it would still have to raise a runtime error to signal
the error on protocol violation. We would then have to write a lot of
tests to make sure such errors never happen in practice. Even so the
tests may not be exhaustive enough to cover all corner cases.</p>
<p>By enforcing the linear usage of channels at compile time, Ferrite helps
eliminate a broad range of communication errors that can happen due to
incorrect implementations. As we will see in later chapters, using Ferrite
we can safely implement complex communication protocols in our Rust programs,
without having to worry about our programs not correctly following
these protocols.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../01-getting-started/03-communication.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../01-getting-started/05-session-types.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../01-getting-started/03-communication.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../01-getting-started/05-session-types.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
