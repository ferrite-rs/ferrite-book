<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Channel Selectors - Writing Session-Typed Ferrite Programs in Rust</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../ferrite.html"><strong aria-hidden="true">1.</strong> Writing Session-Typed Ferrite Programs in Rust</a></li><li class="chapter-item expanded "><a href="../01-getting-started/00-getting-started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01-getting-started/01-installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../01-getting-started/02-hello-world.html"><strong aria-hidden="true">2.2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../01-getting-started/03-communication.html"><strong aria-hidden="true">2.3.</strong> Client Communication</a></li><li class="chapter-item expanded "><a href="../01-getting-started/04-type-errors.html"><strong aria-hidden="true">2.4.</strong> Type Errors</a></li><li class="chapter-item expanded "><a href="../01-getting-started/05-session-types.html"><strong aria-hidden="true">2.5.</strong> Session Types</a></li></ol></li><li class="chapter-item expanded "><a href="../02-main-concepts/00-main-concepts.html"><strong aria-hidden="true">3.</strong> Main Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02-main-concepts/01-protocols.html"><strong aria-hidden="true">3.1.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/02-linear-context.html"><strong aria-hidden="true">3.2.</strong> Linear Context</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/03-sessions.html"><strong aria-hidden="true">3.3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/04-channel-selectors.html" class="active"><strong aria-hidden="true">3.4.</strong> Channel Selectors</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/05-running-sessions.html"><strong aria-hidden="true">3.5.</strong> Running Sessions</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/06-hole-driven-development.html"><strong aria-hidden="true">3.6.</strong> Hole Driven Development</a></li></ol></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/00-ferrite-constructs.html"><strong aria-hidden="true">4.</strong> Ferrite Constructs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../03-ferrite-constructs/01-termination.html"><strong aria-hidden="true">4.1.</strong> Termination</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/02-forward.html"><strong aria-hidden="true">4.2.</strong> Forward</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/03-include.html"><strong aria-hidden="true">4.3.</strong> Include</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/04-apply.html"><strong aria-hidden="true">4.4.</strong> Apply</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/05-step.html"><strong aria-hidden="true">4.5.</strong> Step</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/06-run-session.html"><strong aria-hidden="true">4.6.</strong> Run Session</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/07-receive-value.html"><strong aria-hidden="true">4.7.</strong> Receive Value</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/08-send-value.html"><strong aria-hidden="true">4.8.</strong> Send Value</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/09-receive-channel.html"><strong aria-hidden="true">4.9.</strong> Receive Channel</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/10-send-channel.html"><strong aria-hidden="true">4.10.</strong> Send Channel</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/11-external-choice.html"><strong aria-hidden="true">4.11.</strong> External Choice</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/12-internal-choice.html"><strong aria-hidden="true">4.12.</strong> Internal Choice</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/13-n-ary-choice.html"><strong aria-hidden="true">4.13.</strong> N-ary Choice</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/14-recursive.html"><strong aria-hidden="true">4.14.</strong> Recursive Session Types</a></li></ol></li><li class="chapter-item expanded "><a href="../04-shared-sesion-types/00-shared-session-types.html"><strong aria-hidden="true">5.</strong> Shared Session Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../04-shared-sesion-types/01-shared-provider.html"><strong aria-hidden="true">5.1.</strong> Shared Provider</a></li><li class="chapter-item expanded "><a href="../04-shared-sesion-types/02-run-shared-session.html"><strong aria-hidden="true">5.2.</strong> Run Shared Session</a></li><li class="chapter-item expanded "><a href="../04-shared-sesion-types/03-shared-client.html"><strong aria-hidden="true">5.3.</strong> Shared Client</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> TODO</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Writing Session-Typed Ferrite Programs in Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#channel-selectors" id="channel-selectors">Channel Selectors</a></h1>
<p>In the code for <a href="../01-getting-started/03-communication.html"><code>hello_client</code></a>, we have seen
that the <code>receive_channel</code> construct introduces a new channel variable to our continuation,
which we bind to the variable <code>a</code>. The channel variable <code>a</code> is then used in both
<code>receive_value_from(a, ...)</code> and <code>wait(a, ...)</code> to access the given channel in the linear context.
In this chapter, we will peek a bit into the mechanics of how the channel variables
provide access to channels in the linear context.</p>
<h2><a class="header" href="#context-lenses" id="context-lenses">Context Lenses</a></h2>
<p>Recall from the <a href="./02-linear-context.html">previous chapter</a> that a linear context
has the form <code>HList![A0, A1, ...]</code>, with each element implementing <code>Protocol</code>.
During the execution of a Ferrite program, the session type of the channels
in the linear context will be updated in each step, until the final linear
context has the form <code>HList![Empty, Empty, ...]</code> to be safely terminated.</p>
<p>When some Ferrite constructs such as <code>receive_value_from</code> are called, a channel
variable needs to be given so that the construct can know which channel
in the linear context it should access. Since the linear context is represented
as a type level list, the channels are in fact not named in the linear context.
Instead, channel variables such as <code>a</code> in <code>hello_client</code> actually have types
that implement <em>context lenses</em> to access channels in the linear context
by <em>position</em>.</p>
<p>Conceptually, a type <code>N</code> that implements the <code>ContextLens</code> trait provides
access to a particular element in the type level list, and update it
to a new type. For example in <code>hello_client</code>, the type of <code>a</code> implements
<code>ContextLens</code> for accessing the linear contexts
<code>HList![SendValue&lt;String, End&gt;]</code>, and updates it to <code>HList[End]</code>, then
finally updates it to <code>HList![Empty]</code>.</p>
<h2><a class="header" href="#type-level-natural-numbers" id="type-level-natural-numbers">Type Level Natural Numbers</a></h2>
<p>To define types that implement the <code>ContextLens</code> trait, Ferrite uses
<em>type level natural numbers</em> to implement the access to channels
in the type level list by the corresponding position. A type level
natural number starts with the type <code>Z</code>, which corresponds to the
number 0. Following that, we have the type <code>S&lt;Z&gt;</code>, which means
the <em>successor</em> of <code>Z</code>, to correspond to the number 1.
Similarly, we have <code>S&lt;S&lt;Z&gt;&gt;</code> corresponding to the successor of 1,
which is 2, and so on. So we have the types
<code>Z</code>, <code>S&lt;Z&gt;</code>, <code>S&lt;S&lt;Z&gt;&gt;</code>, <code>S&lt;S&lt;S&lt;Z&gt;&gt;&gt;</code>, ... corresponding to
the number sequence 0, 1, 2, 3, ...</p>
<p>For each of the type level natural numbers, Ferrite implements
the <code>ContextLens</code> trait for accessing channels at the corresponding
zero-indexed position in the linear context. So for example:</p>
<ul>
<li>
<p>The type <code>Z</code> can update any linear context in the form <code>HList![A0, ...]</code> to
<code>HList![B, ...]</code>, with the first element <code>A0</code> replaced with <code>B</code> and the
remaining elements unchanged.</p>
</li>
<li>
<p>The type <code>S&lt;Z&gt;</code> can update any linear context in the form <code>HList![A0, A1, ...]</code> to
<code>HList![A0, B, ...]</code>, with the second element <code>A1</code> replaced with <code>B</code> and
the remaining elements unchanged.</p>
</li>
<li>
<p>The type <code>S&lt;S&lt;Z&gt;&gt;</code> can update any linear context in the form <code>HList![A0, A1, A2, ...]</code> to
<code>HList![A0, A1, B, ...]</code>, with the third element <code>A3</code> replaced with <code>B</code> and
the remaining elements unchanged.</p>
</li>
</ul>
<p>As demonstration, we can deduce that the channel variable <code>a</code> in <code>hello_client</code> has
the type <code>Z</code>, because there is only one channel in the linear context and it is
the one that we are interested in. <code>Z</code> implements the <code>ContextLens</code> for updating
the first element in any linear context. So <code>receive_channel_from</code> can use <code>Z</code>
to update the linear context from <code>HList![ReceiveValue&lt;String, End&gt;]</code> to <code>HList![End]</code>,
and it can also use <code>Z</code> to update the linear context from <code>HList![End]</code> to <code>HList![Empty]</code>.</p>
<h2><a class="header" href="#the-contextlens-trait" id="the-contextlens-trait">The <code>ContextLens</code> Trait</a></h2>
<p>The full definition of the <code>ContextLens</code> trait is in the form <code>ContextLens&lt;C1, A, B, Target=C2&gt;</code>.
It means that a type <code>N</code> that implements <code>ContextLens&lt;C1, A, B, Target=C2&gt;</code> provides
the operation to access a channel of session type <code>A</code> that can be found in <code>C1</code>,
update it to <code>B</code>, and result in the new context <code>C2</code>. This can be elaborated with
the implementations by the natural numbers:</p>
<ul>
<li>
<p><code>Z: ContextLens&lt;HList![A0, ...], A0, B, Target=HList![B, ...]&gt;</code></p>
</li>
<li>
<p><code>S&lt;Z&gt;: ContextLens&lt;HList![A0, A1, ...], A0, B, Target=HList![A0, B, ...]&gt;</code></p>
</li>
<li>
<p><code>S&lt;S&lt;Z&gt;&gt;: ContextLens&lt;HList![A0, A1, A2,...], A0, B, Target=HList![A0, A1, B, ...]&gt;</code></p>
</li>
</ul>
<p>Following the above template, we can know that in the case of <code>hello_client</code>, the type <code>Z</code>
does implements the required <code>ContextLens</code> traits:</p>
<ul>
<li>
<pre><code>Z: ContextList&lt;
      HList![ReceiveValue&lt;String, End&gt;],
      ReceiveValue&lt;String, End&gt;,
      End,
      Target=HList![End]&gt;
</code></pre>
</li>
<li>
<pre><code>Z: ContextList&lt;
      HList![End],
      End,
      Empty,
      Target=HList![Empty]&gt;
</code></pre>
</li>
</ul>
<h2><a class="header" href="#writing-partial-ferrite-programs" id="writing-partial-ferrite-programs">Writing Partial Ferrite Programs</a></h2>
<p>Now that we know how context lenses are actually implemented, it would in fact
be possible for us to write partial Ferrite programs of type <code>PartialSession</code>,
by hard coding the specific context lenses to access the channels in the linear context.
For example, we could have written a partial version of <code>hello_client</code> as follows:</p>
<pre><code class="language-rust noplaypen">  let hello_client_partial: PartialSession&lt;
    HList![SendValue&lt;String, End&gt;],
    End,
  &gt; = receive_value_from(Z, move |greeting| {
    println!(&quot;Received greetings from provider: {}&quot;, greeting);
    wait(Z, terminate())
  });
</code></pre>
<p>While writing such program is possible, the code is not ergonomic and is generally
not recommended. This is because we are hardcoding the position of the channels
in the linear context, instead of using meaningful identifiers. This would also
reduce readability and makes it more difficult to add or remove channels to
the program.</p>
<p>This style of programming using the position is similar to programming using
<a href="https://en.wikipedia.org/wiki/De_Bruijn_index">De Bruijn index</a>. While this
is useful for internal implementation, we as programmers tend to prefer
using named variables to improve readability and better structure our code.</p>
<h2><a class="header" href="#type-errors-using-context-lenses" id="type-errors-using-context-lenses">Type Errors Using Context Lenses</a></h2>
<p>When we write Ferrite programs that contain invalid access to channels in the linear context,
we may get compile errors showing that types like <code>Z</code> do not implement a particular context lens.
As an example, consider the following incorrect version of <code>hello_client</code> that tries to
send a value to <code>a</code> instead of receiving from it:</p>
<pre><code class="language-rust noplaypen">let hello_client_incorrect
  : Session&lt;ReceiveChannel&lt;SendValue&lt;String, End&gt;, End&gt;&gt;
  = receive_channel(|a| {
      send_value_to(a, &quot;Hello World!&quot;.to_string(),
        wait(a, terminate()))
    });
</code></pre>
<p>If we try to compile the program, we would get an error message similar to the following:</p>
<pre><code>error[E0277]: the trait bound `Z: ContextLens&lt;(SendValue&lt;String, End&gt;, ()), ReceiveValue&lt;String, _&gt;, _&gt;` is not satisfied
   |
20 |     send_value_to(a, &quot;Hello World!&quot;.to_string(),
   |     ^^^^^^^^^^^^^ the trait `ContextLens&lt;(SendValue&lt;String, End&gt;, ()), ReceiveValue&lt;String, _&gt;, _&gt;` is not implemented for `Z`
   |
   |
49 |   N: ContextLens&lt;C, ReceiveValue&lt;T, B&gt;, B&gt;,
   |      ------------------------------------- send_value_to`
   |
   = help: the following implementations were found:
             &lt;Z as ContextLens&lt;(A1, C), A1, A2&gt;&gt;
</code></pre>
<p>The key meaning for the error message above is that the type <code>Z</code> does not implement
<code>ContextLens&lt;HList![SendValue&lt;String, End&gt;], ReceiveValue&lt;String, End&gt;, End&gt;</code>.
This is because although <code>Z</code> implements access to the first element of any
non-empty linear context, the first element in the linear context of <code>hello_client</code>
has the protocol <code>SendValue&lt;String, End&gt;</code>, but the call to <code>send_value_to(a, ...)</code>
requires the first element of the linear context to have the protocol
<code>ReceiveValue&lt;String, End&gt;</code>.</p>
<p>Error messages such as above may be difficult to understand for readers who are
new to Ferrite. But hopefully with some exercise, we should be able to get familiar
with the error message and understand the meaning behind them.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../02-main-concepts/03-sessions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../02-main-concepts/05-running-sessions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../02-main-concepts/03-sessions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../02-main-concepts/05-running-sessions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
