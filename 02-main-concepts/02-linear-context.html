<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Linear Context - Writing Session-Typed Ferrite Programs in Rust</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../ferrite.html"><strong aria-hidden="true">1.</strong> Writing Session-Typed Ferrite Programs in Rust</a></li><li class="chapter-item expanded "><a href="../01-getting-started/00-getting-started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01-getting-started/01-installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../01-getting-started/02-hello-world.html"><strong aria-hidden="true">2.2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../01-getting-started/03-communication.html"><strong aria-hidden="true">2.3.</strong> Client Communication</a></li><li class="chapter-item expanded "><a href="../01-getting-started/04-type-errors.html"><strong aria-hidden="true">2.4.</strong> Type Errors</a></li><li class="chapter-item expanded "><a href="../01-getting-started/05-session-types.html"><strong aria-hidden="true">2.5.</strong> Session Types</a></li></ol></li><li class="chapter-item expanded "><a href="../02-main-concepts/00-main-concepts.html"><strong aria-hidden="true">3.</strong> Main Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02-main-concepts/01-protocols.html"><strong aria-hidden="true">3.1.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/02-linear-context.html" class="active"><strong aria-hidden="true">3.2.</strong> Linear Context</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/03-sessions.html"><strong aria-hidden="true">3.3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/04-channel-selectors.html"><strong aria-hidden="true">3.4.</strong> Channel Selectors</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/05-running-sessions.html"><strong aria-hidden="true">3.5.</strong> Running Sessions</a></li><li class="chapter-item expanded "><a href="../02-main-concepts/06-hole-driven-development.html"><strong aria-hidden="true">3.6.</strong> Hole Driven Development</a></li></ol></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/00-ferrite-constructs.html"><strong aria-hidden="true">4.</strong> Ferrite Constructs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../03-ferrite-constructs/01-termination.html"><strong aria-hidden="true">4.1.</strong> Termination</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/02-forward.html"><strong aria-hidden="true">4.2.</strong> Forward</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/03-include.html"><strong aria-hidden="true">4.3.</strong> Include</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/04-apply.html"><strong aria-hidden="true">4.4.</strong> Apply</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/05-step.html"><strong aria-hidden="true">4.5.</strong> Step</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/06-run-session.html"><strong aria-hidden="true">4.6.</strong> Run Session</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/07-receive-value.html"><strong aria-hidden="true">4.7.</strong> Receive Value</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/08-send-value.html"><strong aria-hidden="true">4.8.</strong> Send Value</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/09-receive-channel.html"><strong aria-hidden="true">4.9.</strong> Receive Channel</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/10-send-channel.html"><strong aria-hidden="true">4.10.</strong> Send Channel</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/11-external-choice.html"><strong aria-hidden="true">4.11.</strong> External Choice</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/12-internal-choice.html"><strong aria-hidden="true">4.12.</strong> Internal Choice</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/13-n-ary-choice.html"><strong aria-hidden="true">4.13.</strong> N-ary Choice</a></li><li class="chapter-item expanded "><a href="../03-ferrite-constructs/14-recursive.html"><strong aria-hidden="true">4.14.</strong> Recursive Session Types</a></li></ol></li><li class="chapter-item expanded "><a href="../04-shared-sesion-types/00-shared-session-types.html"><strong aria-hidden="true">5.</strong> Shared Session Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../04-shared-sesion-types/01-shared-provider.html"><strong aria-hidden="true">5.1.</strong> Shared Provider</a></li><li class="chapter-item expanded "><a href="../04-shared-sesion-types/02-run-shared-session.html"><strong aria-hidden="true">5.2.</strong> Run Shared Session</a></li><li class="chapter-item expanded "><a href="../04-shared-sesion-types/03-shared-client.html"><strong aria-hidden="true">5.3.</strong> Shared Client</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> TODO</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Writing Session-Typed Ferrite Programs in Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#linear-context" id="linear-context">Linear Context</a></h1>
<p>A Ferrite program offers exactly one protocol, as denoted by the type <code>Session&lt;A&gt;</code>, with
<code>A</code> being the provided protocol. For example, when we define our
<a href="../01-getting-started/02-hello-world.html"><code>hello_provider</code></a> program
that offers <code>SendValue&lt;String, End&gt;</code>, the type of the program is <code>Session&lt;SendValue&lt;String, End&gt;&gt;</code>.
When we implement <code>hello_provider</code> as <code>send_value(&quot;Hello World!&quot;.to_string(), terminate())</code>,
we are implicitly sending the string value <code>&quot;Hello World!&quot;</code> to the <em>offered</em> channel
of the protocol <code>SendValue&lt;String, End&gt;</code>.</p>
<p>Although a Ferrite program can only have one offered channel, it can also interact with
other Ferrite programs and act as the <em>client</em> of the offered channels. Since there
can be more than one client channels available, we need to identify the different
channels available using <em>channel variables</em>.
So in the case of <a href="../01-getting-started/03-communication.html"><code>hello_client</code></a>,
we bind the channel variable <code>a</code> to the client channel of protocol
<code>SendValue&lt;String, End&gt;</code>, so that it can <em>receive</em> a string value from the provider.</p>
<pre><code class="language-rust noplaypen">  let hello_client: Session&lt;ReceiveChannel&lt;Hello, End&gt;&gt; =
    receive_channel(|a| {
      receive_value_from(a, move |greeting| {
        println!(&quot;Received greetings from provider: {}&quot;, greeting);
        wait(a, terminate())
      })
    });
</code></pre>
<h2><a class="header" href="#type-level-list" id="type-level-list">Type Level List</a></h2>
<p>Ferrite tracks the linear usage of channel variables in a <em>linear context</em>.
A linear context is encoded as a Rust type containing zero or more protocols,
in the form of a <em>type level list</em>. We can use the <code>HList!</code> macro to define
a list of Rust types. For example:</p>
<ul>
<li><code>HList![]</code> is an <em>empty</em> type level list.</li>
<li><code>HList![String]</code> is a type level list with just one element, <code>String</code>.</li>
<li><code>HList![String, i32, bool]</code> is a type level list containing 3 Rust types: <code>String</code>, <code>i32</code>, and <code>bool</code>.</li>
<li><code>HList![SendValue&lt;String, End&gt;, ReceiveValue&lt;i32, End&gt;, End]</code> is a type level list containing 3
Ferrite protocols: <code>SendValue&lt;String, End&gt;</code>, <code>ReceiveValue&lt;i32, End&gt;</code>, and <code>End</code>.</li>
</ul>
<p>Behind the scene, the <code>HList!</code> macro desugars a type level list into nested tuples
of the form <code>(A0, (A1, (A2, (..., (An, ())))))</code>. This is similar to how linked lists
are constructed in Lisp. We start by treating the unit type <code>()</code> as the empty list.
To prepend an element <code>A</code> to the front of another list <code>R</code>, we use the tuple constructor
<code>(,)</code> to form the new list <code>(A, R)</code>, with <code>A</code> being the <em>head</em> of the list and <code>R</code>
being the <em>tail</em> of the list. So for example:</p>
<ul>
<li><code>HList![]</code> desugars to <code>()</code>.</li>
<li><code>HList![String]</code> desugars to <code>(String, ())</code>.</li>
<li><code>HList![String, i32, bool]</code> desugars to <code>(String, (i32, (bool, ())))</code>.</li>
<li><code>HList![SendValue&lt;String, End&gt;, ReceiveValue&lt;i32, End&gt;, End]</code> desugars to
<code>(SendValue&lt;String, End&gt;, (ReceiveValue&lt;i32, End&gt;, (End, ())))</code>.</li>
</ul>
<p>When we encounter compile errors while writing Ferrite programs, we can often
see desugared type level lists shown in the error messages. To understand the
error messages, we just need to recognize the patterns and think of them
as being the same as the pretty printed <code>HList![...]</code> elements.</p>
<h2><a class="header" href="#the-context-trait" id="the-context-trait">The <code>Context</code> trait</a></h2>
<p>Ferrite requires linear contexts to implement the <code>Context</code> trait. This is
automatically implemented for a type level list, if all its elements implement
the <code>Protocol</code> trait. So for example:</p>
<ul>
<li><code>HList![]</code> is a valid linear context, and it is an <em>empty</em> context.</li>
<li><code>HList![SendValue&lt;String, End&gt;]</code> is a linear context with one protocol, <code>SendValue&lt;String, End&gt;</code>.</li>
<li><code>HList![SendValue&lt;String, End&gt;, ReceiveValue&lt;i32, End&gt;, End]</code> is a linear context,
because all 3 elements are valid Ferrite protocols.</li>
<li><code>HList![String, i32, bool]</code> is not a linear context, because none of them are valid
Ferrite protocols.</li>
<li><code>HList![SendValue&lt;String, End&gt;, String]</code> is not a linear context, because the
second element <code>String</code> is not a Ferrite protocol.</li>
<li><code>HList![SendValue&lt;String, End&gt;, ReceiveValue&lt;i32, i32&gt;]</code> is not a linear context,
because the second element <code>ReceiveValue&lt;i32, i32&gt;</code> is not a valid Ferrite protocol.</li>
</ul>
<p>All Ferrite program has an associated linear context, and a program usually starts with an
empty linear context <code>HList![]</code>. For the case of <code>hello_client</code>,
in the beginning it also starts with the empty context. When we use <code>receive_channel</code>
inside <code>hello_client</code>, a new channel is then added to the linear context in the continuation.
As a result, the linear context in the continuation after <code>receive_channel</code> becomes
<code>HList![SendValue&lt;String, End&gt;]</code>, with the channel variable <code>a</code> referring to the first
channel <code>SendValue&lt;String, End&gt;</code>.</p>
<h2><a class="header" href="#empty-slots" id="empty-slots">Empty Slots</a></h2>
<p>When a Ferrite program has a non-empty linear context, it would have to fully
consume all linear channels before it can finally terminate. For the case
of <code>hello_client</code>, this would mean that the linear context <code>HList![SendValue&lt;String, End&gt;]</code>
has to be fully consumed. We do that by first receiving the value using
<code>receive_value_from(a, ...)</code>. In the continuation, the linear context would be
updated to become <code>HList![End]</code> after the value is received. At this point
we would then wait for the channel to terminate using <code>wait(a, ...)</code>.</p>
<p>After the channel <code>a</code> is terminated, the original position of the channel
in the linear context is updated with a special <em>empty slot</em> called <code>Empty</code>.
This is used to indicate that the channel has been fully consumed, and
it may be safe for the program to terminate. So in the continuation
after <code>wait(a, ...)</code>, the linear context is updated to become <code>HList![Empty]</code>.</p>
<p>Compared to <code>End</code>, <code>Empty</code> is not a protocol. So we cannot for example define a
Ferrite program  that offers <code>Empty</code>. However <code>Empty</code> is treated as a valid
element in a linear context. So a type level list like
<code>HList![Empty, SendValue&lt;String, End&gt;]</code> also implements <code>Context</code>.</p>
<h2><a class="header" href="#empty-context" id="empty-context">Empty Context</a></h2>
<p>When we call <code>terminate()</code>, Ferrite checks whether a linear context is empty
using the <code>EmptyContext</code> trait. This trait is implemented if the linear context
is an empty list <code>HList![]</code>, or if all elements in the linear context is <code>Empty</code>.
So <code>HList![]</code>, <code>HList![Empty]</code>, <code>HList![Empty, Empty]</code>, and so on all implement
<code>EmptyContext</code>.</p>
<p>When we try to call <code>terminate()</code> with a non-empty linear context,
we will get a compile error stating that the type <code>HList![...]</code> does not
implement <code>EmptyContext</code>. When encountering such error, we can inspect
the list and see which element is not empty, and update our Ferrite
program to fully consume the channel accordingly.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../02-main-concepts/01-protocols.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../02-main-concepts/03-sessions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../02-main-concepts/01-protocols.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../02-main-concepts/03-sessions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
